<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brewlio – Coffee Taste Quiz</title>

  <link rel="stylesheet" href="style.css" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☕</text></svg>">

  <!-- Supabase client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <!-- Top bar -->
  <header class="t-bar">
    <nav class="nav-left" aria-label="Primary">
      <a href="index.html#about">How it works</a>
      <a href="index.html#shop">Roasts</a>
      <a href="index.html#why">Why local</a>
      <a href="index.html#partner">Roasters</a>
    </nav>
    <a href="index.html" class="logo logo-link" aria-label="Brewlio home">
      <span class="logo-main">BREWLIO</span>
      <span class="logo-sub">coffee that just makes sense</span>
    </a>
  </header>

  <!-- Greeting -->
  <div id="greeting" class="greeting" aria-live="polite">
    <strong>One minute to better coffee.</strong>
    <span class="tip">Pick what sounds like you. No jargon.</span>
  </div>

  <!-- Quiz Section -->
  <section class="quiz-section">
    <div class="quiz-container">

      <div class="quiz-header">
        <h1>Coffee Taste Quiz</h1>
        <p class="quiz-lede">
          We'll match you with beans based on your taste + how you drink coffee.
          <span class="quiz-lede-sub">Free. No account. Retake anytime.</span>
        </p>

        <div class="quiz-meta" aria-label="Progress">
          <span id="stepText" class="step-text">Question 1 of 6</span>
          <span id="stepHint" class="step-hint">Pick one to continue</span>
        </div>
      </div>

      <form id="coffeeQuiz" novalidate>
        <!-- Q1 -->
        <fieldset class="question active" data-q="brew">
          <legend>How do you usually make coffee?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNWp4cXN4MHcyNXFobXJycW14dmhsYWJmaHp1NHN1c2N0NTdkcHp5OCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/mQCc4gIeZf746w1hSZ/giphy.gif" type="image/gif">
              <img src="Assets/espresso_fallback.jpg" alt="Espresso shot pulling" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Brew method">
            <div class="option">
              <input type="radio" id="brew-espresso" name="brew" value="espresso" required>
              <label for="brew-espresso">Espresso machine</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-pourover" name="brew" value="pour-over">
              <label for="brew-pourover">Pour-over / filter</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-plunger" name="brew" value="french-press">
              <label for="brew-plunger">French press / plunger</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-moka" name="brew" value="stovetop">
              <label for="brew-moka">Stovetop (moka pot)</label>
            </div>
            <div class="option">
              <input type="radio" id="brew-other" name="brew" value="other">
              <label for="brew-other">Other / instant (no judgement)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q2 -->
        <fieldset class="question" data-q="milk">
          <legend>Do you drink it with milk?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExejF3a2ticTA2N2ZvOTBrd2ZqZTNxd2NrbnFheHE0M3NkeTVwbmk0YyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/h55EUEsTG9224/giphy.gif" type="image/gif">
              <img src="Assets/milk_fallback.jpg" alt="Pouring milk into coffee" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Milk preference">
            <div class="option">
              <input type="radio" id="milk-black" name="milk" value="black" required>
              <label for="milk-black">Always black</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-sometimes" name="milk" value="sometimes">
              <label for="milk-sometimes">Sometimes</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-always" name="milk" value="always">
              <label for="milk-always">Always with milk</label>
            </div>
          </div>
        </fieldset>

        <!-- Q3 -->
        <fieldset class="question" data-q="flavour">
          <legend>What flavours do you enjoy?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNnVtMm80OXQ4MXh2endvMnp4OHd5ZWZ1YzdjN3MzYWhwaGx1NW8zMSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Q6joirtIBHUsw/giphy.gif" type="image/gif">
              <img src="Assets/fruity_fallback.jpg" alt="Coffee pour" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Flavour preference">
            <div class="option">
              <input type="radio" id="flavour-fruity" name="flavour" value="fruity" required>
              <label for="flavour-fruity">Bright, fruity, juicy</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-choc" name="flavour" value="chocolate">
              <label for="flavour-choc">Chocolate, nutty, caramel</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-balanced" name="flavour" value="balanced">
              <label for="flavour-balanced">Balanced — a bit of both</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-bold" name="flavour" value="bold">
              <label for="flavour-bold">Bold, dark, intense</label>
            </div>
          </div>
        </fieldset>

        <!-- Q4 -->
        <fieldset class="question" data-q="roast">
          <legend>How dark do you like your roast?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExYzRyYXk2NHJreHRxdDRraThzeGg3bnY4bmczbXBuNnIxdjdkNjh6dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/lg6LhRzBjPO6xIaHen/giphy.gif" type="image/gif">
              <img src="Assets/roast_fallback.jpg" alt="Coffee beans roasting" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Roast preference">
            <div class="option">
              <input type="radio" id="roast-light" name="roast" value="light" required>
              <label for="roast-light">Light — I want origin character</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-medium" name="roast" value="medium">
              <label for="roast-medium">Medium — classic & smooth</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-dark" name="roast" value="dark">
              <label for="roast-dark">Dark — big & bold</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-any" name="roast" value="any">
              <label for="roast-any">Not sure / surprise me</label>
            </div>
          </div>
        </fieldset>

        <!-- Q5 -->
        <fieldset class="question" data-q="acidity">
          <legend>How do you feel about acidity?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media3.giphy.com/media/v1.Y2lkPTc5MGI3NjExbDg0MWd2bGszcHczaXB5MTVoeW1yMDFoamNsYzdxa2ZpYXBpemt3diZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/8cN6wDcWdzEGBsIRya/giphy.gif" type="image/gif">
              <img src="Assets/acidity_fallback.jpg" alt="Coffee pour" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Acidity preference">
            <div class="option">
              <input type="radio" id="acid-love" name="acidity" value="love" required>
              <label for="acid-love">Love it — bright & lively</label>
            </div>
            <div class="option">
              <input type="radio" id="acid-moderate" name="acidity" value="moderate">
              <label for="acid-moderate">A little is fine</label>
            </div>
            <div class="option">
              <input type="radio" id="acid-low" name="acidity" value="low">
              <label for="acid-low">Low acidity please</label>
            </div>
          </div>
        </fieldset>

        <!-- Q6 -->
        <fieldset class="question" data-q="level">
          <legend>How serious are you about coffee?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://i.pinimg.com/originals/0c/6e/89/0c6e899de70d7f175b8476d1b0ab6443.gif" type="image/gif">
              <img src="Assets/latteart_fallback.jpg" alt="Latte art" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Experience level">
            <div class="option">
              <input type="radio" id="lvl-casual" name="level" value="casual" required>
              <label for="lvl-casual">Casual drinker</label>
            </div>
            <div class="option">
              <input type="radio" id="lvl-enth" name="level" value="enthusiast">
              <label for="lvl-enth">Enthusiast</label>
            </div>
            <div class="option">
              <input type="radio" id="lvl-pro" name="level" value="pro">
              <label for="lvl-pro">I’m basically a barista</label>
            </div>
          </div>
        </fieldset>

        <!-- Controls -->
        <div class="quiz-controls">
          <button type="button" id="prevBtn" class="quiz-btn secondary" disabled>Previous</button>
          <button type="button" id="nextBtn" class="quiz-btn primary" disabled>Next</button>
          <button type="submit" id="submitBtn" class="quiz-btn primary hidden" disabled>Show my match →</button>
        </div>

        <div class="progress-bar" aria-hidden="true">
          <div class="progress"></div>
        </div>

        <p id="errorText" class="quiz-error" role="status" aria-live="polite"></p>
      </form>

      <!-- Results -->
      <div id="results" class="results hidden">
        <h2>Your coffee match</h2>
        <p class="results-lede">Here's what fits your taste — and why.</p>
        <div id="recommendation"></div>

        <div class="results-actions">
          <a href="index.html" class="btn-primary">Back to home</a>
          <button type="button" id="retakeBtn" class="btn-secondary">Retake quiz</button>
        </div>
      </div>

    </div>
  </section>

  <script>
    // Greeting
    (async () => {
      const el = document.getElementById('greeting');
      let city = null;
      try {
        const r = await fetch('https://ipapi.co/json/');
        if (r.ok) {
          const data = await r.json();
          if (data && data.city) city = data.city;
        }
      } catch (_) {}

      const messages = [
        `Almost there${city ? `, ${city}` : ''}. Pick what sounds like you.`,
        `Quick quiz${city ? ` in ${city}` : ''} → better coffee.`,
        `One minute${city ? ` in ${city}` : ''}. Fewer regret-bags.`
      ];
      const msg = messages[Math.floor(Math.random() * messages.length)];
      el.innerHTML = `<strong>${msg}</strong><span class="tip">No jargon. No account. Just taste.</span>`;
    })();

    // -------------------- Supabase setup (safe) --------------------
    const SUPABASE_URL = "YOUR_PROJECT_URL";
    const SUPABASE_ANON_KEY = "YOUR_ANON_KEY";

    let sb = null;
    try {
      const hasRealSupabaseConfig =
        typeof SUPABASE_URL === "string" &&
        SUPABASE_URL.startsWith("http") &&
        SUPABASE_URL.includes("supabase.co") &&
        typeof SUPABASE_ANON_KEY === "string" &&
        SUPABASE_ANON_KEY.length > 50;

      if (hasRealSupabaseConfig && window.supabase && typeof window.supabase.createClient === "function") {
        sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      }
    } catch (err) {
      console.warn("Supabase init failed (quiz still works):", err);
      sb = null;
    }

    const safeId = () => {
      try {
        if (window.crypto && typeof window.crypto.randomUUID === "function") return window.crypto.randomUUID();
      } catch (_) {}
      return "sid_" + Date.now() + "_" + Math.random().toString(16).slice(2);
    };

    const sessionId = localStorage.getItem("brewlio_sid") || (() => {
      const id = safeId();
      localStorage.setItem("brewlio_sid", id);
      return id;
    })();

    // -------------------- Quiz logic --------------------
    const form = document.getElementById('coffeeQuiz');
    const questions = Array.from(document.querySelectorAll('.question'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progress = document.querySelector('.progress');
    const results = document.getElementById('results');
    const recommendation = document.getElementById('recommendation');
    const stepText = document.getElementById('stepText');
    const stepHint = document.getElementById('stepHint');
    const errorText = document.getElementById('errorText');
    const retakeBtn = document.getElementById('retakeBtn');

    let currentQuestion = 0;

    function total() { return questions.length; }

    function isAnswered(n) {
      return !!questions[n].querySelector('input[type="radio"]:checked');
    }

    function setButtons() {
      prevBtn.disabled = currentQuestion === 0;

      const last = currentQuestion === total() - 1;
      const answered = isAnswered(currentQuestion);

      nextBtn.classList.toggle('hidden', last);
      submitBtn.classList.toggle('hidden', !last);

      nextBtn.disabled = !answered;
      submitBtn.disabled = !answered;

      stepText.textContent = `Question ${currentQuestion + 1} of ${total()}`;
      stepHint.textContent = answered ? 'Nice — continue' : 'Pick one to continue';
    }

    function showQuestion(n) {
      questions.forEach((q, i) => q.classList.toggle('active', i === n));
      errorText.textContent = '';
      progress.style.width = `${((n + 1) / total()) * 100}%`;
      setButtons();
      questions[n].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    // Enable buttons when user selects an option
    form.addEventListener('change', (e) => {
      if (e.target && e.target.matches('input[type="radio"]')) setButtons();
    });

    nextBtn.addEventListener('click', () => {
      if (!isAnswered(currentQuestion)) {
        errorText.textContent = 'Pick an option to continue.';
        return;
      }
      currentQuestion = Math.min(total() - 1, currentQuestion + 1);
      showQuestion(currentQuestion);
    });

    prevBtn.addEventListener('click', () => {
      currentQuestion = Math.max(0, currentQuestion - 1);
      showQuestion(currentQuestion);
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      if (!isAnswered(currentQuestion)) {
        errorText.textContent = 'Pick an option to see your match.';
        return;
      }

      const data = new FormData(form);
      const answers = Object.fromEntries(data);

      let roast = 'medium';
      let style = 'balanced & smooth';

      if (answers.brew === 'espresso' || answers.brew === 'stovetop') roast = 'medium-dark';
      if (answers.brew === 'pour-over') roast = 'light';
      if (answers.roast === 'light') roast = 'light';
      if (answers.roast === 'dark') roast = 'dark';

      if (answers.flavour === 'fruity' || answers.acidity === 'love') style = 'bright & fruity (think Ethiopian / Kenyan)';
      if (answers.flavour === 'chocolate') style = 'chocolatey & nutty (think Colombian / Brazilian)';
      if (answers.flavour === 'balanced') style = 'balanced & sweet (classic crowd-pleaser)';
      if (answers.flavour === 'bold') style = 'bold & intense (robust blend / Indonesian)';

      if (answers.milk === 'always' && roast === 'light') roast = 'medium';
      if (answers.milk === 'always') roast = 'medium-dark';

      const recs = {
        light: {
          title: 'Light Roast',
          line: `You’ll likely enjoy ${style}.`,
          why: 'Light roasts lean into brightness and origin flavours — ideal for filter / pour-over.'
        },
        medium: {
          title: 'Medium Roast',
          line: `You’ll likely enjoy ${style}.`,
          why: 'Medium roasts balance sweetness and body — versatile for most brew methods.'
        },
        'medium-dark': {
          title: 'Medium-Dark Roast',
          line: `You’ll likely enjoy richer, fuller-bodied coffee (${style}).`,
          why: 'Great with milk. More body and chocolate notes, less sharpness.'
        },
        dark: {
          title: 'Dark Roast',
          line: 'You’ll likely enjoy bold, intense, lower-acidity coffee.',
          why: 'Classic espresso style — heavy body, roast-forward flavour, forgiving with milk.'
        }
      };

      const pick = recs[roast] || recs.medium;

      const brewText = (answers.brew || 'brew method').replace('-', ' ');
      const milkText =
        answers.milk === 'black'
          ? 'black'
          : (answers.milk === 'always' ? 'with milk' : 'either black or with milk');

      recommendation.innerHTML = `
        <div class="result-card">
          <p class="rec-title">Your match:</p>
          <h3>${pick.title}</h3>
          <p class="result-line">${pick.line}</p>

          <div class="why-box">
            <p class="why-title">Why this fits you</p>
            <p>${pick.why}</p>
            <p class="why-meta">Optimised for <strong>${brewText}</strong> and drinking it <strong>${milkText}</strong>.</p>
          </div>

          <p class="small">Coming soon: direct links to Melbourne roasters that match this exact profile.</p>
        </div>
      `;

      // Supabase insert (non-blocking)
      try {
        if (sb) {
          sb.from("quiz_events").insert({
            created_at: new Date().toISOString(),
            session_id: sessionId,
            page: "quiz",
            answers: answers,
            result: {
              roast: roast,
              style: style,
              pick_title: pick?.title || null,
              brew_text: brewText,
              milk_text: milkText
            },
            user_agent: navigator.userAgent,
            referrer: document.referrer || null
          }).then(({ error }) => {
            if (error) console.warn("Supabase insert error:", error);
          }).catch((err) => console.warn("Supabase insert failed:", err));
        }
      } catch (err) {
        console.warn("Supabase insert crashed (quiz still ok):", err);
      }

      results.classList.remove('hidden');
      form.classList.add('hidden');
      results.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    retakeBtn.addEventListener('click', () => {
      form.reset();
      results.classList.add('hidden');
      form.classList.remove('hidden');
      currentQuestion = 0;
      showQuestion(0);
    });

    showQuestion(0);
  </script>
</body>
</html>
