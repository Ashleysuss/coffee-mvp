<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Brewlio – Coffee Taste Quiz</title>

  <meta name="description" content="Brewlio matches you to beans based on your grinder, machine, and taste. No jargon. No signup. About a minute." />
  <link rel="stylesheet" href="style.css" />

  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>☕</text></svg>">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

  <header class="t-bar">
    <nav class="nav-left" aria-label="Primary">
      <a href="index.html#about">How it works</a>
      <a href="index.html#shop">Roasts</a>
      <a href="index.html#why">Why Local</a>
      <a href="index.html#partner">Roasters</a>
    </nav>
    <a href="index.html" class="logo logo-link" aria-label="Brewlio home">
      <span class="logo-main">BREWLIO</span>
      <span class="logo-sub">coffee that just makes sense</span>
    </a>
  </header>

  <div id="greeting" class="greeting" aria-live="polite">
    <strong>Alright — quick one.</strong>
    <span class="tip">Pick what sounds like you. No jargon. No account.</span>
  </div>

  <section class="quiz-section">
    <div class="quiz-container">

      <div class="quiz-header">
        <h1>Coffee Taste Quiz</h1>
        <p class="quiz-lede">
          We'll match you to beans based on taste + setup (because it matters).
          <span class="quiz-lede-sub">Free. No account. Retake anytime.</span>
        </p>

        <div class="quiz-meta" aria-label="Progress">
          <span id="stepText" class="step-text">Question 1 of 8</span>
          <span id="stepHint" class="step-hint">Pick one to continue</span>
        </div>
      </div>

      <form id="coffeeQuiz" novalidate>
        <!-- Q1: Brew method -->
        <fieldset class="question active" data-q="brew">
          <legend>How do you usually brew coffee?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExNWp4cXN4MHcyNXFobXJycW14dmhsYWJmaHp1NHN1c2N0NTdkcHp5OCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/mQCc4gIeZf746w1hSZ/giphy.gif" type="image/gif">
              <img src="Assets/espresso_fallback.jpg" alt="Espresso shot pulling" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Brew method">
            <div class="option">
              <input type="radio" id="brew-espresso" name="brew" value="espresso" required>
              <label for="brew-espresso">Espresso machine <span class="muted">(Breville, Gaggia)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="brew-manual" name="brew" value="manual">
              <label for="brew-manual">Manual filter <span class="muted">(V60, AeroPress)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="brew-batch" name="brew" value="batch">
              <label for="brew-batch">Batch filter <span class="muted">(Moccamaster)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="brew-body" name="brew" value="body">
              <label for="brew-body">Immersion / stovetop <span class="muted">(Press, moka)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="brew-other" name="brew" value="other">
              <label for="brew-other">Other / instant <span class="muted">(no judgement)</span></label>
            </div>
          </div>
        </fieldset>

        <!-- Q2: Grinder -->
        <fieldset class="question" data-q="grinder">
          <legend>What are you grinding with?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExaWdlZGh5M3dyMXBqbjlqY2dhcWhjcWNpNnR6ZTk3MjAwNmpnZ2d2eiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/YlN4W49tpnRduYwY0L/giphy.gif" type="image/gif">
              <img src="Assets/roast_fallback.jpg" alt="Grinding coffee" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Grinder tier">
            <div class="option">
              <input type="radio" id="gr-pre" name="grinder" value="pre-ground" required>
              <label for="gr-pre">Pre-ground (or I don’t grind)</label>
            </div>
            <div class="option">
              <input type="radio" id="gr-blade" name="grinder" value="blade">
              <label for="gr-blade">Blade grinder <span class="muted">(chaos)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="gr-entry" name="grinder" value="burr-entry">
              <label for="gr-entry">Entry burr <span class="muted">(SGP, Encore)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="gr-good" name="grinder" value="burr-good">
              <label for="gr-good">Good burr <span class="muted">(DF64, Niche)</span></label>
            </div>
            <div class="option">
              <input type="radio" id="gr-pro" name="grinder" value="pro">
              <label for="gr-pro">High-end / commercial <span class="muted">(078/s, EK43)</span></label>
            </div>
          </div>
          <p class="micro-note" id="grinderHint" style="margin-top:10px;">
            Hand grinders count — placement depends on brew style.
          </p>
        </fieldset>

        <!-- Q3: Espresso machine (conditional) -->
        <fieldset class="question" data-q="machine" data-conditional="espresso">
          <legend>If you make espresso, what machine tier is closest?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="Assets/Question3.gif" type="image/gif">
              <img src="Assets/espresso_fallback.jpg" alt="Espresso machine" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Espresso machine tier">
            <div class="option">
              <input type="radio" id="mach-entry" name="machine" value="entry">
              <label for="mach-entry">Entry (Bambino, basic SB)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-capable" name="machine" value="capable">
              <label for="mach-capable">Capable (Gaggia, Silvia)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-advanced" name="machine" value="advanced">
              <label for="mach-advanced">Advanced (Dual boiler / HX)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-elite" name="machine" value="elite">
              <label for="mach-elite">Elite (Linea Mini, E61)</label>
            </div>
            <div class="option">
              <input type="radio" id="mach-notsure" name="machine" value="not-sure">
              <label for="mach-notsure">Not sure (fair)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q4: Milk -->
        <fieldset class="question" data-q="milk">
          <legend>What's your deal with milk?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExejF3a2ticTA2N2ZvOTBrd2ZqZTNxd2NrbnFheHE0M3NkeTVwbmk0YyZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/h55EUEsTG9224/giphy.gif" type="image/gif">
              <img src="Assets/milk_fallback.jpg" alt="Pouring milk into coffee" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Milk preference">
            <div class="option">
              <input type="radio" id="milk-black" name="milk" value="black" required>
              <label for="milk-black">Always black</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-sometimes" name="milk" value="sometimes">
              <label for="milk-sometimes">Sometimes</label>
            </div>
            <div class="option">
              <input type="radio" id="milk-always" name="milk" value="always">
              <label for="milk-always">Always with milk</label>
            </div>
          </div>
        </fieldset>

        <!-- Q5: Flavour -->
        <fieldset class="question" data-q="flavour">
          <legend>What flavours do you enjoy?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExdjh6cjVrNGQ3dzJvZ3B6bWs4NnEwNG4zZTZoa210Ymd6bXZvNmtsbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/4barzGdH1TB4aakAMv/giphy.gif" type="image/gif">
              <img src="Assets/fruity_fallback.jpg" alt="Coffee pour" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Flavour preference">
            <div class="option">
              <input type="radio" id="flavour-fruity" name="flavour" value="fruity" required>
              <label for="flavour-fruity">Juicy fruit</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-clean" name="flavour" value="clean">
              <label for="flavour-clean">Clean & tea-like</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-choc" name="flavour" value="chocolate">
              <label for="flavour-choc">Chocolate, nutty, caramel</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-balanced" name="flavour" value="balanced">
              <label for="flavour-balanced">Balanced</label>
            </div>
            <div class="option">
              <input type="radio" id="flavour-bold" name="flavour" value="bold">
              <label for="flavour-bold">Rich & heavy</label>
            </div>
          </div>
        </fieldset>

        <!-- Q6: Roast -->
        <fieldset class="question" data-q="roast">
          <legend>How dark do you like your roast?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExYzRyYXk2NHJreHRxdDRraThzeGg3bnY4bmczbXBuNnIxdjdkNjh6dSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/lg6LhRzBjPO6xIaHen/giphy.gif" type="image/gif">
              <img src="Assets/roast_fallback.jpg" alt="Coffee beans roasting" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Roast preference">
            <div class="option">
              <input type="radio" id="roast-light" name="roast" value="light" required>
              <label for="roast-light">Light (less roast taste)</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-medium" name="roast" value="medium">
              <label for="roast-medium">Medium (sweet spot)</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-mediumdark" name="roast" value="medium-dark">
              <label for="roast-mediumdark">Medium-dark (syrupy)</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-dark" name="roast" value="dark">
              <label for="roast-dark">Dark (more roast taste)</label>
            </div>
            <div class="option">
              <input type="radio" id="roast-any" name="roast" value="any">
              <label for="roast-any">Not sure / surprise me</label>
            </div>
          </div>
        </fieldset>

        <!-- Q7: Skill -->
        <fieldset class="question" data-q="skill">
          <legend>How deep are you in the rabbit hole?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media.giphy.com/media/26BRv0ThflsHCqDrG/giphy.gif" type="image/gif">
              <img src="Assets/latteart_fallback.jpg" alt="Coffee workflow" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Skill level">
            <div class="option">
              <input type="radio" id="sk-beginner" name="skill" value="beginner" required>
              <label for="sk-beginner">Beginner (just tastes good)</label>
            </div>
            <div class="option">
              <input type="radio" id="sk-basic" name="skill" value="basic">
              <label for="sk-basic">Basic (I follow recipes)</label>
            </div>
            <div class="option">
              <input type="radio" id="sk-inter" name="skill" value="intermediate">
              <label for="sk-inter">Intermediate (I adjust)</label>
            </div>
            <div class="option">
              <input type="radio" id="sk-advanced" name="skill" value="advanced">
              <label for="sk-advanced">Advanced (ratios are normal)</label>
            </div>
            <div class="option">
              <input type="radio" id="sk-nerd" name="skill" value="nerd">
              <label for="sk-nerd">Unwell (I see channels)</label>
            </div>
          </div>
        </fieldset>

        <!-- Q8: Pain -->
        <fieldset class="question" data-q="pain">
          <legend>What ruins a coffee for you?</legend>
          <div class="question-gif">
            <picture>
              <source srcset="https://media.giphy.com/media/3o6Zt481isNVuQI1l6/giphy.gif" type="image/gif">
              <img src="Assets/latteart_fallback.jpg" alt="Coffee frustration" loading="lazy" />
            </picture>
          </div>
          <div class="options" role="radiogroup" aria-label="Biggest coffee frustration">
            <div class="option">
              <input type="radio" id="pn-sour" name="pain" value="sour" required>
              <label for="pn-sour">Sour / sharp</label>
            </div>
            <div class="option">
              <input type="radio" id="pn-bitter" name="pain" value="bitter">
              <label for="pn-bitter">Bitter / harsh</label>
            </div>
            <div class="option">
              <input type="radio" id="pn-weak" name="pain" value="weak">
              <label for="pn-weak">Weak / watery</label>
            </div>
            <div class="option">
              <input type="radio" id="pn-muddy" name="pain" value="muddy">
              <label for="pn-muddy">Muddy / gritty</label>
            </div>
            <div class="option">
              <input type="radio" id="pn-inconsistent" name="pain" value="inconsistent">
              <label for="pn-inconsistent">Inconsistent</label>
            </div>
          </div>
        </fieldset>

        <div class="quiz-controls">
          <button type="button" id="prevBtn" class="quiz-btn secondary" disabled>Previous</button>
          <button type="button" id="nextBtn" class="quiz-btn primary">Next</button>
          <button type="submit" id="submitBtn" class="quiz-btn primary hidden" disabled>Show my match →</button>
        </div>

        <div class="progress-bar" aria-hidden="true">
          <div class="progress"></div>
        </div>

        <p id="errorText" class="quiz-error" role="status" aria-live="polite"></p>
      </form>

      <div id="results" class="results" hidden>
        <h2>Your coffee match</h2>
        <p class="results-lede">Here's what fits your taste — and why.</p>
        <div id="recommendation"></div>

        <div class="results-actions">
          <a href="index.html" class="btn-primary">Back to home</a>
          <button type="button" id="retakeBtn" class="btn-secondary">Retake quiz</button>
        </div>
      </div>

    </div>
  </section>

  <script>
    // Greeting
    (() => {
      const el = document.getElementById('greeting');
      el.innerHTML = `<strong>Alright — quick one.</strong><span class="tip">Pick what sounds like you. No jargon. No account.</span>`;
    })();

    // Supabase
    const SUPABASE_URL = "https://opledkjivawysybvbqxe.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_FxH-YkKnC8mZD8R0hSgXEg_mgrR20K_";

    let sb = null;
    try {
      const ok =
        typeof SUPABASE_URL === "string" && SUPABASE_URL.startsWith("http") && SUPABASE_URL.includes("supabase.co") &&
        typeof SUPABASE_ANON_KEY === "string" && SUPABASE_ANON_KEY.length > 10;
      if (ok && window.supabase?.createClient) sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    } catch (err) {
      console.warn("Supabase init failed:", err);
    }

    const sessionId = (() => {
      const key = "brewlio_sid";
      let id = localStorage.getItem(key);
      if (!id) {
        id = crypto.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2));
        localStorage.setItem(key, id);
      }
      return id;
    })();

    let quizStartMs = Date.now();
    const nowMs = () => Date.now();

    const form = document.getElementById('coffeeQuiz');
    const allQuestions = Array.from(document.querySelectorAll('.question'));
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');
    const progress = document.querySelector('.progress');
    const results = document.getElementById('results');
    const recommendation = document.getElementById('recommendation');
    const stepText = document.getElementById('stepText');
    const stepHint = document.getElementById('stepHint');
    const errorText = document.getElementById('errorText');
    const retakeBtn = document.getElementById('retakeBtn');
    const grinderHint = document.getElementById('grinderHint');

    function setGrinderHint(brew) {
      if (!grinderHint) return;
      grinderHint.textContent = (brew === 'espresso')
        ? "Hand grinders count — great for filter; espresso is a workout."
        : "Hand grinders count — coarser brews are their happy place.";
    }

    let currentIndex = 0;
    let activeQuestions = [];
    let isSubmitting = false;

    results.hidden = true;
    form.hidden = false;

    function getAnswer(name) {
      return form.querySelector(`input[name="${name}"]:checked`)?.value || null;
    }

    function rebuildActiveQuestions() {
      const brew = getAnswer('brew');
      activeQuestions = allQuestions.filter(q => {
        const cond = q.getAttribute('data-conditional');
        return !cond || cond === brew;
      });

      const machine = allQuestions.find(q => q.getAttribute('data-q') === 'machine');
      if (machine) {
        const inputs = machine.querySelectorAll('input[type="radio"]');
        const isActive = activeQuestions.includes(machine);
        inputs.forEach(i => i.required = isActive);
        if (!isActive) inputs.forEach(i => i.checked = false);
      }

      currentIndex = Math.min(currentIndex, activeQuestions.length - 1);
    }

    function total() { return activeQuestions.length; }
    function isAnswered(idx) { return !!activeQuestions[idx]?.querySelector('input[type="radio"]:checked'); }

    function setButtons() {
      prevBtn.disabled = currentIndex === 0;

      const last = currentIndex === total() - 1;
      const answered = isAnswered(currentIndex);

      nextBtn.classList.toggle('hidden', last);
      submitBtn.classList.toggle('hidden', !last);

      nextBtn.disabled = !answered;
      submitBtn.disabled = !answered;

      stepText.textContent = `Question ${currentIndex + 1} of ${total()}`;
      stepHint.textContent = answered ? 'Nice — continue' : 'Pick one to continue';
    }

    function showQuestion(idx) {
      allQuestions.forEach(q => q.classList.remove('active'));
      activeQuestions[idx].classList.add('active');

      errorText.textContent = '';
      progress.style.width = `${((idx + 1) / total()) * 100}%`;
      setButtons();
      activeQuestions[idx].scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    form.addEventListener('change', (e) => {
      if (!e.target.matches('input[type="radio"]')) return;

      if (e.target.name === 'brew') {
        const brew = getAnswer('brew') || 'other';
        setGrinderHint(brew);
        rebuildActiveQuestions();
        showQuestion(currentIndex);
        return;
      }
      setButtons();
    });

    nextBtn.addEventListener('click', () => {
      if (!isAnswered(currentIndex)) { errorText.textContent = 'Pick an option to continue.'; return; }
      currentIndex++;
      showQuestion(currentIndex);
    });

    prevBtn.addEventListener('click', () => {
      currentIndex--;
      showQuestion(currentIndex);
    });

    // Recommendation helpers
    function pickOrigins({ roast, flavour, brew, milk }) {
      const pools = {
        light: ["Ethiopia", "Kenya", "Costa Rica", "Rwanda", "Tanzania"],
        mediumSweet: ["Brazil", "Colombia", "Guatemala", "El Salvador", "Costa Rica"],
        mediumClean: ["Colombia", "Costa Rica", "Kenya", "Rwanda", "Guatemala"],
        mediumDark: ["Brazil", "Colombia", "Guatemala", "Honduras", "Indonesia (Sumatra)"],
        dark: ["Brazil", "Indonesia (Sumatra)", "India", "Vietnam"]
      };

      let selectedPool = pools.mediumSweet;

      if (roast === 'light') selectedPool = pools.light;
      else if (roast === 'medium-dark') selectedPool = pools.mediumDark;
      else if (roast === 'dark') selectedPool = pools.dark;
      else if (roast === 'medium') {
        if (flavour === 'chocolate' || flavour === 'bold') selectedPool = pools.mediumSweet;
        else selectedPool = pools.mediumClean;
      }

      if (brew === 'espresso' && milk === 'always' && roast !== 'dark') {
        selectedPool = pools.mediumSweet;
      }

      const shuffled = [...selectedPool].sort(() => 0.5 - Math.random());
      const origin1 = shuffled[0];
      const origin2 = shuffled[1] || shuffled[0];

      return `${origin1} or ${origin2}`;
    }

    function pushUnique(arr, msg) { if (!arr.includes(msg)) arr.push(msg); }

    function resultStyleLine(roast, flavour, brew, milk) {
      const isMilk = (milk === 'always');
      const isFilter = (brew === 'manual' || brew === 'batch');

      if (roast === 'light') {
        if (flavour === 'chocolate' || flavour === 'bold') return "a lighter cup that’s still sweet (not sour-for-fun)";
        if (isMilk) return "something light-leaning, but with enough sweetness to survive milk";
        return "a bright, clean cup with high clarity";
      }

      if (roast === 'medium') {
        if (flavour === 'fruity') return "sweet cups with a little sparkle (no sharp edges)";
        if (flavour === 'clean') return "clean sweetness and clarity (without going full lemon-water)";
        if (flavour === 'bold') return "comfort flavours with some weight — sweet, not ashy";
        if (isMilk) return "sweet, milk-friendly comfort flavours";
        return "sweet, balanced, easy-to-love cups";
      }

      if (roast === 'medium-dark') {
        if (isFilter) return "syrupy sweetness without the harsh roast bite";
        if (isMilk) return "thicker, milk-friendly sweetness (choc/caramel energy)";
        return "richer body with a sweet finish";
      }

      if (flavour === 'fruity' || flavour === 'clean') return "roasty comfort (not a fruit salad)";
      return "big, roasty comfort flavours with low acidity";
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (isSubmitting) return;
      if (!isAnswered(currentIndex)) { errorText.textContent = 'Pick an option to see your match.'; return; }

      isSubmitting = true;
      submitBtn.disabled = true;
      const originalSubmitText = submitBtn.textContent;
      submitBtn.textContent = "Saving…";

      const submissionId = crypto.randomUUID?.() || (Date.now().toString(36) + Math.random().toString(36).slice(2));

      try {
        const a = Object.fromEntries(new FormData(form));

        const brew = a.brew || 'other';
        const grinder = a.grinder || 'pre-ground';
        const machine = a.machine || 'not-sure';
        const skill = a.skill || 'basic';
        const pain = a.pain || 'inconsistent';
        const roastPrefAny = (a.roast === 'any');

        const requestedRoast = (!roastPrefAny && a.roast) ? a.roast : null;
        let roast = requestedRoast || 'medium';

        const strongNotes = [];

        let styleLabel = 'balanced & sweet';
        if (a.flavour === 'fruity') styleLabel = 'juicy fruit';
        if (a.flavour === 'clean') styleLabel = 'clean, tea-like';
        if (a.flavour === 'chocolate') styleLabel = 'choc / nut / caramel';
        if (a.flavour === 'balanced') styleLabel = 'balanced & sweet';
        if (a.flavour === 'bold') styleLabel = 'rich & heavy';

        // Capability flags
        const hasWeakGrinder = ['pre-ground', 'blade', 'burr-entry'].includes(grinder);
        const hasGoodGrinder = (grinder === 'burr-good' || grinder === 'pro');
        const hasAdvancedSkill = (skill === 'advanced' || skill === 'nerd');
        const hasCapableEspresso = brew === 'espresso' && (machine === 'advanced' || machine === 'elite');

        function overrideRoast(newRoast, note) {
          if (roast !== newRoast) {
            roast = newRoast;
            pushUnique(strongNotes, note);
          }
        }

        // === REFINED LOGIC: Respect preference + expertise ===
        if (requestedRoast) {
          // Weak grinder + light → override
          if (hasWeakGrinder && roast === 'light') {
            overrideRoast('medium-dark', "Light roasts need consistent grind. With entry-level grinding, they often taste sour. Medium-dark is more reliable.");
          }

          // Milk + light → only if not expert setup
          if (a.milk === 'always' && roast === 'light' && !(hasGoodGrinder && hasAdvancedSkill)) {
            overrideRoast('medium-dark', "Milk can mask the delicate notes in light roasts. Medium-dark usually gives better body and sweetness with milk.");
          }

          // Filter + dark → override
          if ((brew === 'manual' || brew === 'batch') && roast === 'dark') {
            overrideRoast('medium', "Dark roasts in filter can taste harsh or ashy. Medium keeps sweetness and clarity.");
          }

          // Espresso + light on entry machine → only if not skilled
          if (brew === 'espresso' && roast === 'light') {
            const entryMachine = (machine === 'entry' || machine === 'not-sure');
            if (entryMachine && !hasAdvancedSkill) {
              overrideRoast('medium', "Light roasts on entry machines can be uneven. Medium extracts more consistently.");
            }
          }

          // Pain-driven (only if not expert)
          if (!hasAdvancedSkill) {
            if (pain === 'sour' && roast === 'light') {
              overrideRoast('medium', "If sourness bothers you, light roasts can amplify it. Medium is easier to extract sweetly.");
            }
            if (pain === 'bitter' && roast === 'dark') {
              overrideRoast('medium-dark', "If bitter is the enemy, very dark roasts can make it worse. Medium-dark is often cleaner.");
            }
          }

          // Muddy pain + weak grinder → nudge away from extremes
          if (pain === 'muddy' && hasWeakGrinder) {
            if (roast === 'light') overrideRoast('medium', "Muddy texture often comes from inconsistent grind. Medium roasts are more forgiving.");
            if (roast === 'dark') overrideRoast('medium-dark', "Very dark with fines can feel muddy. Medium-dark is usually cleaner.");
          }
        }

        // Gentle nudges (only if no strong preference)
        if (!requestedRoast || requestedRoast === 'medium') {
          if (a.milk === 'always' && (a.flavour === 'bold' || a.flavour === 'chocolate') && (brew === 'espresso' || brew === 'body') && !hasAdvancedSkill) {
            roast = 'medium-dark';
          }
        }

        // "Any roast" → intelligent default
        if (roastPrefAny) {
          roast = 'medium';
          if (hasGoodGrinder && hasAdvancedSkill && (a.flavour === 'fruity' || a.flavour === 'clean')) {
            roast = 'light';
          } else if ((brew === 'espresso' || brew === 'body') && a.milk === 'always') {
            roast = 'medium-dark';
          }
        }

        const recs = {
          light: { title: 'Light Roast', why: 'More origin character, less roast taste. Bright when extracted well.' },
          medium: { title: 'Medium Roast', why: 'Sweet, forgiving, and works on most setups without drama.' },
          'medium-dark': { title: 'Medium-Dark Roast', why: 'Syrupy body, great with milk, and generally hard to mess up.' },
          dark: { title: 'Dark Roast', why: 'Big roast taste, low acidity, very forgiving (if that’s your vibe).' }
        };

        const pick = recs[roast] || recs.medium;

        const origins = pickOrigins({ roast, flavour: a.flavour, brew, milk: a.milk });
        const displayStyle = resultStyleLine(roast, a.flavour, brew, a.milk);

        const brewText = ({
          espresso: 'espresso',
          manual: 'manual filter',
          batch: 'batch filter',
          body: 'immersion / stovetop',
          other: 'other'
        }[brew] || brew);

        const milkText = (a.milk === 'black') ? 'black' : (a.milk === 'always' ? 'with milk' : 'either');

        const durationMs = Math.max(0, nowMs() - quizStartMs);

        let html = `
          <div class="result-card">
            <p class="rec-title">Your match:</p>
            <h3>${pick.title}</h3>
            <p class="result-line">You’ll probably vibe with <strong>${displayStyle}</strong> — think <strong>${origins}</strong>.</p>

            <div class="why-box">
              <p class="why-title">Why this fits you</p>
              <p>${pick.why}</p>
              <p class="why-meta">
                Built for <strong>${brewText}</strong>, drinking it <strong>${milkText}</strong>,
                with a <strong>${grinder.replace('-', ' ')}</strong> grinder.
              </p>
            </div>
        `;

        if (strongNotes.length > 0) {
          html += `
            <div class="why-box" style="background:rgba(255,52,0,0.08); border:1px solid rgba(255,52,0,0.2);">
              <p class="why-title" style="color:var(--brand);">A note from experience</p>
              <ul style="text-align:left; margin:10px 0; padding-left:20px;">
                ${strongNotes.map(n => `<li>${n}</li>`).join('')}
              </ul>
            </div>
          `;
        }

        // Email capture CTA - added class="cta-panel"
        html += `
          <div class="why-box cta-panel" style="margin-top:32px; padding:24px;">
            <p class="why-title" style="color:var(--brand); margin-bottom:8px; font-size:1.2rem;">Want fresh bags that actually match this?</p>
            <p style="margin-bottom:20px; font-size:1.05rem;">
              We’re launching a small weekly drop of beans that fit your exact profile.<br>
              No spam. One email only when something perfect lands.
            </p>
            <form id="emailForm" style="display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
              <input 
                type="email" 
                id="userEmail" 
                placeholder="your@email.com" 
                required 
                aria-label="Your email address"
                style="padding:14px 18px; border-radius:16px; border:1px solid #ccc; min-width:260px; font-size:1rem; flex:1;"
              />
              <button 
                type="submit" 
                class="quiz-btn primary" 
                style="min-width:160px;"
              >
                Send me matches
              </button>
            </form>
            <p style="margin-top:12px; font-size:0.9rem; opacity:0.8;">
              No junk. Unsubscribe anytime. We hate spam too.
            </p>
          </div>
        `;

        html += `<p class="small" style="margin-top:24px;">Coming soon: direct links to Aussie roasters that match this profile.</p></div>`;

        recommendation.innerHTML = html;

        results.hidden = false;
        form.hidden = true;
        results.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Supabase quiz submission
        if (sb) {
          const payload = {
            submission_id: submissionId,
            session_id: sessionId,
            page: location.pathname,
            quiz_version: "v2.4",
            duration_ms: durationMs,
            brew: brew || null,
            grinder: grinder || null,
            machine: brew === 'espresso' ? (machine || null) : null,
            milk: a.milk || null,
            flavour: a.flavour || null,
            roast_pref: a.roast || null,
            skill: skill || null,
            pain: pain || null,
            match_roast: roast || null,
            match_style: styleLabel || null,
            match_origins: origins || null,
            answers: a,
            derived: { roast, styleLabel, origins, brew, grinder, machine, skill, pain, notes: { strong: strongNotes } }
          };

          const { error } = await sb.from("quiz_events").insert(payload);
          if (error) console.warn("Supabase error:", error);
        }

        // Email form handler
        const emailForm = document.getElementById('emailForm');
        if (emailForm && sb) {
          emailForm.addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const emailInput = document.getElementById('userEmail');
            const email = emailInput?.value.trim();

            if (!email || !email.includes('@')) {
              emailInput.style.borderColor = 'var(--brand)';
              return;
            }

            const btn = emailForm.querySelector('button[type="submit"]');
            const origText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending…';

            try {
              await sb.from('email_signups').insert({
                email: email,
                session_id: sessionId,
                submission_id: submissionId,
                source: 'quiz_result',
                created_at: new Date().toISOString()
              });

              emailForm.innerHTML = `<p style="font-weight:900; color:var(--brand); text-align:center;">Got it — we'll be in touch when something perfect lands.</p>`;
            } catch (err) {
              console.warn('Email signup failed:', err);
              btn.textContent = 'Try again';
            } finally {
              btn.disabled = false;
              if (origText) btn.textContent = origText;
            }
          });
        }

      } catch (err) {
        console.warn("Submit failed:", err);
      } finally {
        submitBtn.textContent = originalSubmitText;
      }
    });

    retakeBtn.addEventListener('click', () => {
      isSubmitting = false;
      quizStartMs = nowMs();

      form.reset();
      results.hidden = true;
      form.hidden = false;

      currentIndex = 0;
      rebuildActiveQuestions();
      setGrinderHint(getAnswer('brew') || 'other');
      showQuestion(currentIndex);
    });

    rebuildActiveQuestions();
    setGrinderHint(getAnswer('brew') || 'other');
    showQuestion(0);
  </script>
</body>
</html>